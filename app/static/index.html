<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Card Inventory Scanner</title>
  <style>
    body { 
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #0b0c10; 
      color: #eaf0f6; 
      min-height: 100vh;
    }
    
    header { 
      padding: 12px 16px; 
      text-align: center; 
      background: #1f2833; 
      position: sticky; 
      top: 0; 
      z-index: 1; 
    }
    
    header h2 {
      margin: 0;
      font-size: 1.5rem;
    }
    
    main { 
      padding: 12px; 
      max-width: 100%;
      margin: 0 auto;
    }
    
         @media (min-width: 768px) {
       main {
         padding: 16px;
         max-width: 600px;
       }
       
       header h2 {
         font-size: 2rem;
       }
       
       /* Larger logo on desktop */
       header img[alt="JC & Sons Logo"] {
         height: 40px !important;
         max-width: 120px !important;
         left: 20px !important;
       }
     }
     
     /* Medium screens */
     @media (min-width: 480px) and (max-width: 767px) {
       header img[alt="JC & Sons Logo"] {
         height: 36px !important;
         max-width: 100px !important;
         left: 18px !important;
       }
     }
     
     /* Small mobile screens */
     @media (max-width: 479px) {
       header img[alt="JC & Sons Logo"] {
         height: 28px !important;
         max-width: 70px !important;
         left: 12px !important;
       }
       
       header h2 {
         font-size: 1.3rem;
       }
     }
    
    .card { 
      background: #14171a; 
      border-radius: 12px; 
      padding: 16px; 
      box-shadow: 0 2px 12px rgba(0,0,0,.35); 
      margin-bottom: 16px; 
    }
    
    .grid { 
      display: grid; 
      gap: 12px; 
    }
    
    video { 
      width: 100%; 
      max-height: 40vh; 
      background: #000; 
      border-radius: 10px; 
      border: 2px solid #333; 
    }
    
    @media (max-width: 767px) {
      video {
        max-height: 35vh;
      }
    }
    video.testing { border: 2px solid #45a29e; background: #1a1a1a; box-shadow: 0 0 10px rgba(69, 162, 158, 0.5); }
    video.error { border: 2px solid #e74c3c; background: #2a1a1a; box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }
    video:not([srcObject]) { background: #1a1a1a; border: 2px dashed #666; }
    button { 
      font-size: 16px; 
      padding: 12px 16px; 
      border: none; 
      border-radius: 10px; 
      background: #45a29e; 
      color: #0b0c10; 
      font-weight: 700; 
      cursor: pointer; 
      min-height: 44px; /* iOS touch target minimum */
      touch-action: manipulation;
    }
    
    button.secondary { background: #c5c6c7; color: #0b0c10; }
    button.danger { background: #e74c3c; color: white; }
    button.success { background: #27ae60; color: white; }
    
    /* Mobile button grid */
    .button-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr;
    }
    
    @media (min-width: 480px) {
      .button-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (min-width: 768px) {
      .button-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }
    }
    input[type="text"], input[type="number"], textarea, select { 
      width: 100%; 
      padding: 12px; 
      font-size: 16px; 
      border-radius: 8px; 
      border: 1px solid #334; 
      background: #0f1113; 
      color: #eaf0f6; 
      margin-bottom: 12px; 
      box-sizing: border-box;
      -webkit-appearance: none;
      border-radius: 8px;
    }
    
    textarea { 
      resize: vertical; 
      min-height: 80px; 
    }
    
    select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }
    
    .row { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
    }
    
    .toast { 
      margin-top: 8px; 
      padding: 12px; 
      border-radius: 8px; 
      background: #173f2a; 
      color: #b7ffd8; 
      display: none; 
      font-size: 14px;
    }
    .error { background: #3f1717; color: #ffb7b7; }
    .warning { background: #3f2f17; color: #ffd7b7; }
    .info { background: #172a3f; color: #b7d8ff; }
    .muted { color: #9aa5b1; font-size: 14px; }
    .small { font-size: 12px; }
    a { color: #66fcf1; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: 600; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
    .modal-content { 
      position: relative; 
      background: #14171a; 
      margin: 10px; 
      padding: 20px; 
      border-radius: 12px; 
      max-width: 500px; 
      max-height: 90vh; 
      overflow-y: auto; 
    }
    
    @media (min-width: 768px) {
      .modal-content {
        margin: 20px auto;
      }
    }
    
    .close { 
      position: absolute; 
      top: 10px; 
      right: 15px; 
      font-size: 24px; 
      cursor: pointer; 
      color: #9aa5b1; 
      padding: 8px;
      min-height: 44px;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close:hover { color: #eaf0f6; }
    .hidden { display: none; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .flex-1 { flex: 1; }
    .gap-2 { gap: 8px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-4 { margin-bottom: 16px; }

    /* Inventory modal styles */
    .inventory-list {
      max-height: 60vh;
      overflow-y: auto;
    }

    .inventory-item {
      background: #1f2833;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #45a29e;
    }

         .item-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 8px;
     }

     .item-actions {
       display: flex;
       align-items: center;
       gap: 8px;
     }

     .quantity {
       background: #45a29e;
       color: #0b0c10;
       padding: 2px 8px;
       border-radius: 12px;
       font-size: 0.9em;
       font-weight: bold;
     }

     .edit-btn {
       background: #2a3f4c;
       color: #eaf0f6;
       border: 1px solid #45a29e;
       padding: 4px 8px;
       border-radius: 6px;
       font-size: 0.8em;
       cursor: pointer;
       transition: all 0.2s ease;
     }

     .edit-btn:hover {
       background: #45a29e;
       color: #0b0c10;
     }

    .item-details {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .item-details span {
      background: #2a3f4c;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85em;
    }

         .game { color: #45a29e; }
     .set { color: #c5c6c7; }
     .brand { color: #e74c3c; }
     .price { color: #27ae60; }

    .location {
      font-size: 0.9em;
      color: #c5c6c7;
      margin-bottom: 4px;
    }

         .description {
       font-size: 0.85em;
       color: #a0a0a0;
       font-style: italic;
     }

     /* Selection styles */
     .inventory-controls {
       display: flex;
       align-items: center;
       gap: 8px;
       flex-wrap: wrap;
     }

     .item-checkbox {
       margin-right: 8px;
       transform: scale(1.2);
       accent-color: #45a29e;
     }

     .inventory-item.selected {
       border-left: 4px solid #e74c3c;
       background: #2a1a1a;
     }

     .inventory-item .item-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       margin-bottom: 8px;
     }

     .item-selection {
       display: flex;
       align-items: center;
       gap: 8px;
     }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    // Check if QuaggaJS loaded successfully
    if (typeof Quagga === 'undefined') {
      console.error('QuaggaJS library failed to load');
    } else {
      console.log('QuaggaJS library loaded successfully');
    }
  </script>
</head>
<body>
           <header>
      <div style="position: relative; display: flex; justify-content: center; align-items: center;">
        <!-- JC Logo Image -->
        <img src="/static/jc-logo.png" alt="JC & Sons Logo" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); height: 32px; width: auto; max-width: 80px; min-width: 24px; object-fit: contain;">
        <h2>JC & Sons Inventory</h2>
        <button id="refreshBtn" style="position: absolute; right: 0; background: none; border: none; color: #eaf0f6; font-size: 1.2rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" title="Refresh page">üîÑ</button>
      </div>
    </header>
  <main class="grid">
    <section class="card">
      <div class="grid">
                 <video id="video" playsinline autoplay muted style="display: none;"></video>
                 <div class="button-grid">
           <button id="startBtn">Start Scanning</button>
           <button id="stopBtn" class="secondary">Stop Scanner</button>
           <button id="debugBtn" class="secondary" style="grid-column: 1 / -1;">üîß Debug Mode: OFF</button>
         </div>
                 <div class="muted small">
           <strong>iPhone Camera Issues?</strong><br>
           ‚Ä¢ Use Safari (not Chrome)<br>
           ‚Ä¢ Go to Settings ‚Üí Privacy ‚Üí Camera ‚Üí Safari<br>
           ‚Ä¢ Try adding to Home Screen<br>
           ‚Ä¢ Use manual entry below as backup
         </div>
        <div id="toast" class="toast"></div>
      </div>
    </section>

    <section class="card">
      <h3>Manual Entry</h3>
      <div class="form-group">
        <input type="text" id="manualBarcode" placeholder="Enter barcode (UPC/EAN)" inputmode="numeric" />
      </div>
      <div class="form-group">
        <button id="manualBtn">Add</button>
      </div>
    </section>

    <section class="card">
      <h3>Inventory Management</h3>
      <div class="button-grid">
        <button id="viewInventoryBtn" class="success">üìä View My Inventory</button>
                 <button id="searchInventoryBtn" class="secondary">üîç Search</button>
        <button id="exportInventoryBtn" class="secondary">üì§ Export Data</button>
      </div>
    </section>

         <section class="card">
       <h3>Tips</h3>
       <ul>
         <li><strong>Add to Home Screen:</strong>
           <ul>
             <li><strong>iPhone/iPad:</strong> Tap the Share button (üì§) ‚Üí "Add to Home Screen" ‚Üí "Add"</li>
             <li><strong>Android Chrome:</strong> Tap menu (‚ãÆ) ‚Üí "Add to Home screen" ‚Üí "Add"</li>
             <li><strong>Android Firefox:</strong> Tap menu (‚ãÆ) ‚Üí "Add to Home Screen" ‚Üí "Add"</li>
           </ul>
         </li>
         <li>Good lighting improves scan reliability.</li>
         <li>Use landscape if autofocus struggles.</li>
         <li>New items will prompt for additional details.</li>
         <li>Use Safari on iPhone for best camera compatibility.</li>
       </ul>
       <div class="small muted">API: <a href="/docs">Swagger</a></div>
     </section>

         <!-- Inventory Display Section -->
     <section id="inventorySection" class="card" style="display: none;">
       <h3 id="inventoryTitle">My Card Inventory</h3>
       <p class="muted" id="inventoryCount">0 items found</p>
       
       <div class="inventory-controls" style="margin-bottom: 12px;">
         <button id="selectAllBtn" class="secondary" style="margin-right: 8px;">‚òê Select All</button>
         <button id="deleteSelectedBtn" class="danger" style="display: none;">üóëÔ∏è Delete Selected (<span id="selectedCount">0</span>)</button>
       </div>
       
       <div id="inventoryList" class="inventory-list">
         <!-- Inventory items will be displayed here -->
       </div>
       
       <div class="button-grid">
         <button id="closeInventoryBtn" class="secondary">Close Inventory</button>
       </div>
     </section>
  </main>

     <!-- New Item Modal -->
   <div id="newItemModal" class="modal">
     <div class="modal-content">
       <span class="close" onclick="closeNewItemModal()">&times;</span>
       <h3>Add New Item</h3>
       <p class="muted">Barcode: <span id="newItemBarcode"></span></p>
       
       <form id="newItemForm">
         <div class="form-group">
           <label for="itemName">Name</label>
           <input type="text" id="itemName" placeholder="Card name">
         </div>
         
         <div class="form-group">
           <label for="itemGame">Game</label>
           <select id="itemGame">
             <option value="">Select game...</option>
             <option value="Pok√©mon">Pok√©mon</option>
             <option value="Magic: The Gathering">Magic: The Gathering</option>
             <option value="Yu-Gi-Oh!">Yu-Gi-Oh!</option>
             <option value="NFL">NFL</option>
             <option value="NBA">NBA</option>
             <option value="MLB">MLB</option>
             <option value="WNBA">WNBA</option>
             <option value="Hockey">Hockey</option>
             <option value="College">College</option>
             <option value="MMA">MMA</option>
             <option value="Soccer">Soccer</option>
             <option value="Other">Other</option>
           </select>
         </div>
         
         <div class="form-group">
           <label for="itemSet">Set</label>
           <input type="text" id="itemSet" placeholder="Set name">
         </div>
                   <div class="form-group">
            <label for="itemBrand">Brand</label>
            <input type="text" id="itemBrand" placeholder="Card brand">
          </div>
         
         <div class="form-group">
           <label for="itemQuantity">Quantity</label>
           <input type="number" id="itemQuantity" value="1" min="1">
         </div>
         
         <div class="form-group">
           <label for="itemPrice">Price ($)</label>
           <input type="number" id="itemPrice" step="0.01" min="0" placeholder="0.00">
         </div>
         
         <div class="form-group">
           <label for="itemLocation">Location</label>
           <input type="text" id="itemLocation" placeholder="Binder, box, etc.">
         </div>
         
         <div class="form-group">
           <label for="itemDescription">Description</label>
           <textarea id="itemDescription" placeholder="Additional details about the card..."></textarea>
         </div>
         
         <div class="form-group">
           <label for="itemNotes">Notes</label>
           <textarea id="itemNotes" placeholder="Personal notes..."></textarea>
         </div>
         
         <div class="form-group">
           <button type="submit" class="success">Add Item</button>
         </div>
         <div class="form-group">
           <button type="button" class="secondary" onclick="closeNewItemModal()">Cancel</button>
         </div>
       </form>
     </div>
   </div>

   <!-- Edit Item Modal -->
   <div id="editItemModal" class="modal">
     <div class="modal-content">
       <span class="close" onclick="closeEditItemModal()">&times;</span>
       <h3>Edit Item</h3>
       <p class="muted">Barcode: <span id="editItemBarcode"></span></p>
       
       <form id="editItemForm">
         <div class="form-group">
           <label for="editItemName">Name</label>
           <input type="text" id="editItemName" placeholder="Card name">
         </div>
         
         <div class="form-group">
           <label for="editItemGame">Game</label>
           <select id="editItemGame">
             <option value="">Select game...</option>
             <option value="Pok√©mon">Pok√©mon</option>
             <option value="Magic: The Gathering">Magic: The Gathering</option>
             <option value="Yu-Gi-Oh!">Yu-Gi-Oh!</option>
             <option value="NFL">NFL</option>
             <option value="NBA">NBA</option>
             <option value="MLB">MLB</option>
             <option value="WNBA">WNBA</option>
             <option value="Hockey">Hockey</option>
             <option value="College">College</option>
             <option value="MMA">MMA</option>
             <option value="Soccer">Soccer</option>
             <option value="Other">Other</option>
           </select>
         </div>
         
         <div class="form-group">
           <label for="editItemSet">Set</label>
           <input type="text" id="editItemSet" placeholder="Set name">
         </div>
                   <div class="form-group">
            <label for="editItemBrand">Brand</label>
            <input type="text" id="editItemBrand" placeholder="Card brand">
          </div>
         
         <div class="form-group">
           <label for="editItemQuantity">Quantity</label>
           <input type="number" id="editItemQuantity" value="1" min="1">
         </div>
         
         <div class="form-group">
           <label for="editItemPrice">Price ($)</label>
           <input type="number" id="editItemPrice" step="0.01" min="0" placeholder="0.00">
         </div>
         
         <div class="form-group">
           <label for="editItemLocation">Location</label>
           <input type="text" id="editItemLocation" placeholder="Binder, box, etc.">
         </div>
         
         <div class="form-group">
           <label for="editItemDescription">Description</label>
           <textarea id="editItemDescription" placeholder="Additional details about the card..."></textarea>
         </div>
         
         <div class="form-group">
           <label for="editItemNotes">Notes</label>
           <textarea id="editItemNotes" placeholder="Personal notes..."></textarea>
         </div>
         
                   <div class="form-group" style="display: flex; gap: 8px; justify-content: space-between;">
            <button type="submit" class="success">Update Item</button>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="secondary" onclick="closeEditItemModal()">Cancel</button>
              <button type="button" class="danger" onclick="deleteItem()">üóëÔ∏è Delete</button>
            </div>
          </div>
       </form>
     </div>
   </div>

  <script>
         const startBtn = document.getElementById('startBtn');
     const stopBtn = document.getElementById('stopBtn');
    const video = document.getElementById('video');
    const toast = document.getElementById('toast');
    const manualInput = document.getElementById('manualBarcode');
    const manualBtn = document.getElementById('manualBtn');
         const newItemModal = document.getElementById('newItemModal');
     const newItemForm = document.getElementById('newItemForm');
     const newItemBarcode = document.getElementById('newItemBarcode');
     const editItemModal = document.getElementById('editItemModal');
     const editItemForm = document.getElementById('editItemForm');
     const editItemBarcode = document.getElementById('editItemBarcode');

         let codeReader = null;
     let currentStream = null;
     let lastText = '';
     let lastAt = 0;
     let pendingBarcode = null;
     let isScanning = false;
     let selectedItems = new Set();
     let allItems = [];
     let debugMode = false;
    
    

    // Detect iOS device
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // Check if camera API is supported
    const isCameraSupported = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) || 
                              !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
    
    // Check if we're on HTTPS (required for camera access)
    const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    
    
    // Test QuaggaJS library on page load
    function testQuaggaLibrary() {
      console.log('Testing QuaggaJS library...');
      if (typeof Quagga === 'undefined') {
        console.error('QuaggaJS library not loaded');
        showToast('Barcode library not loaded!', 'error');
        return false;
      }
      
      // Test if we can access Quagga methods
      try {
        console.log('QuaggaJS library loaded successfully');
        console.log('Available Quagga methods:', Object.getOwnPropertyNames(Quagga));
        return true;
      } catch (e) {
        console.error('Failed to access QuaggaJS methods:', e);
        showToast('Barcode reader initialization failed!', 'error');
        return false;
      }
    }

         // Initialize on page load
     document.addEventListener('DOMContentLoaded', () => {
       console.log('Page loaded, initializing...');
       
       // Test QuaggaJS library
       if (!testQuaggaLibrary()) {
         return;
       }
       
       // Add video event listeners for debugging
       video.addEventListener('loadedmetadata', () => {
         console.log('Video metadata loaded:', {
           videoWidth: video.videoWidth,
           videoHeight: video.videoHeight,
           duration: video.duration
         });
       });
       
       video.addEventListener('canplay', () => {
         console.log('Video can play - stream is ready');
       });
       
       video.addEventListener('error', (e) => {
         console.error('Video error:', e);
         showToast('Video stream error', 'error');
       });
      
      // Check browser compatibility
      console.log('Browser compatibility check:');
      console.log('- User Agent:', navigator.userAgent);
      console.log('- Camera API supported:', isCameraSupported);
      console.log('- Secure context:', isSecure);
      console.log('- iOS device:', isIOS);
      console.log('- navigator.mediaDevices:', !!navigator.mediaDevices);
      if (navigator.mediaDevices) {
        console.log('- getUserMedia supported:', !!navigator.mediaDevices.getUserMedia);
      }
      
             // Check camera support
       if (!isCameraSupported) {
         console.log('Camera API not supported');
         showToast('Camera not supported in this browser. Use manual entry.', 'warning');
       }
      
      if (!isSecure) {
        console.log('Not on HTTPS - camera access may be limited');
        showToast('Camera access requires HTTPS. Use manual entry or access via your computer\'s IP address.', 'warning');
      }
    });

    

    // Polyfill for older browsers
    function getUserMediaPolyfill(constraints) {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        return navigator.mediaDevices.getUserMedia(constraints);
      }
      
      // Fallback for older browsers
      const getUserMedia = navigator.getUserMedia || 
                          navigator.webkitGetUserMedia || 
                          navigator.mozGetUserMedia || 
                          navigator.msGetUserMedia;
      
      if (!getUserMedia) {
        return Promise.reject(new Error('getUserMedia not supported'));
      }
      
      return new Promise((resolve, reject) => {
        getUserMedia.call(navigator, constraints, resolve, reject);
      });
    }

         function showToast(msg, type='success') {
       toast.textContent = msg;
       toast.className = `toast ${type}`;
       toast.style.display = 'block';
       setTimeout(() => { toast.style.display = 'none'; }, 3000);
     }
     
     // Barcode validation function
     function validateBarcode(code) {
       if (!code || typeof code !== 'string') {
         return { valid: false, reason: 'Invalid code type' };
       }
       
       // Remove any non-numeric characters for UPC/EAN validation
       const cleanCode = code.replace(/\D/g, '');
       
       if (cleanCode.length < 8) {
         return { valid: false, reason: 'Code too short' };
       }
       
       if (cleanCode.length > 13) {
         return { valid: false, reason: 'Code too long' };
       }
       
       // Check for common barcode patterns
       const patterns = {
         upc: /^\d{12}$/,
         ean13: /^\d{13}$/,
         ean8: /^\d{8}$/,
         code128: /^[A-Za-z0-9\-\.\/\+\s]+$/,
         code39: /^[A-Z0-9\-\.\/\+\s\$\%]+$/
       };
       
       for (const [format, pattern] of Object.entries(patterns)) {
         if (pattern.test(cleanCode)) {
           return { valid: true, format: format, cleanCode: cleanCode };
         }
       }
       
       return { valid: true, format: 'unknown', cleanCode: cleanCode };
     }

    function showNewItemModal(barcode) {
      pendingBarcode = barcode;
      newItemBarcode.textContent = barcode;
      newItemModal.style.display = 'block';
      document.getElementById('itemName').focus();
    }

         function closeNewItemModal() {
       newItemModal.style.display = 'none';
       pendingBarcode = null;
       newItemForm.reset();
     }

     function showEditItemModal(itemId) {
       // Fetch the item data and populate the form
       fetch(`/api/items/${itemId}`)
         .then(response => response.json())
         .then(item => {
                       document.getElementById('editItemBarcode').textContent = item.barcode || 'N/A';
            document.getElementById('editItemName').value = item.name || '';
            document.getElementById('editItemGame').value = item.game || '';
            document.getElementById('editItemSet').value = item.set_name || '';
            document.getElementById('editItemBrand').value = item.brand || '';
            document.getElementById('editItemQuantity').value = item.quantity || 1;
            document.getElementById('editItemPrice').value = item.price || '';
            document.getElementById('editItemLocation').value = item.location || '';
            document.getElementById('editItemDescription').value = item.description || '';
            document.getElementById('editItemNotes').value = item.notes || '';
           
           // Store the item ID for the form submission
           editItemForm.dataset.itemId = itemId;
           
           editItemModal.style.display = 'block';
           document.getElementById('editItemName').focus();
         })
         .catch(error => {
           console.error('Error fetching item:', error);
           showToast('Failed to load item data', 'error');
         });
     }

     function closeEditItemModal() {
       editItemModal.style.display = 'none';
       editItemForm.reset();
       delete editItemForm.dataset.itemId;
     }

           async function updateItem(formData) {
        const itemId = editItemForm.dataset.itemId;
        if (!itemId) {
          showToast('No item ID found', 'error');
          return;
        }

        try {
          console.log('Updating item:', itemId, formData);
          
          const res = await fetch(`/api/items/${itemId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            console.error('Server error:', errorData);
            throw new Error(`HTTP ${res.status}: ${errorData.detail || 'Unknown error'}`);
          }
          
          const item = await res.json();
          showToast(`Updated: ${item.name} (qty ${item.quantity})`);
          closeEditItemModal();
          
          // Refresh the inventory display
          if (document.getElementById('inventorySection').style.display !== 'none') {
            viewInventory();
          }
        } catch (e) {
          console.error('Error updating item:', e);
          showToast(`Error: ${e.message}`, 'error');
        }
      }

      async function deleteItem() {
        const itemId = editItemForm.dataset.itemId;
        if (!itemId) {
          showToast('No item ID found', 'error');
          return;
        }

        // Get the item name for confirmation
        const itemName = document.getElementById('editItemName').value || 'this item';
        
        // Ask for confirmation
        const confirmed = confirm(`Are you sure you want to delete "${itemName}"?\n\nThis action cannot be undone.`);
        if (!confirmed) {
          return;
        }

        try {
          console.log('Deleting item:', itemId);
          showToast('Deleting item...', 'warning');
          
          const res = await fetch(`/api/items/${itemId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            console.error('Server error:', errorData);
            throw new Error(`HTTP ${res.status}: ${errorData.detail || 'Unknown error'}`);
          }
          
          showToast(`Deleted: ${itemName}`, 'success');
          closeEditItemModal();
          
          // Refresh the inventory display
          if (document.getElementById('inventorySection').style.display !== 'none') {
            viewInventory();
          }
        } catch (e) {
          console.error('Error deleting item:', e);
          showToast(`Error: ${e.message}`, 'error');
        }
      }

    async function postScan(barcode) {
      try {
        const res = await fetch('/api/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ barcode, increment: 1 })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const result = await res.json();
        
        if (result.is_new) {
          showToast(`New barcode detected: ${barcode}`, 'warning');
          showNewItemModal(barcode);
        } else {
          showToast(`Added: ${result.item.name || result.item.barcode} (qty ${result.item.quantity})`);
        }
      } catch (e) {
        console.error(e);
        showToast('Error adding item', 'error');
      }
    }

    async function createNewItem(formData) {
      try {
        console.log('Submitting form data:', formData);
        
        const res = await fetch('/api/items/new', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          console.error('Server error:', errorData);
          throw new Error(`HTTP ${res.status}: ${errorData.detail || 'Unknown error'}`);
        }
        
        const item = await res.json();
        showToast(`Added: ${item.name} (qty ${item.quantity})`);
        closeNewItemModal();
      } catch (e) {
        console.error('Error creating item:', e);
        showToast(`Error: ${e.message}`, 'error');
      }
    }

    

         async function startScanning() {
       if (isScanning) {
         showToast('Scanner already running!', 'warning');
         return;
       }
       
       if (!isCameraSupported) {
         showToast('Camera not supported in this browser. Use manual entry.', 'error');
         return;
       }
       
       // Check if QuaggaJS library is loaded
       if (typeof Quagga === 'undefined') {
         showToast('Barcode library not loaded. Please refresh the page.', 'error');
         console.error('QuaggaJS library not available');
         return;
       }

       try {
         console.log('Starting QuaggaJS scanner...');
         showToast('Starting scanner...', 'warning');
         
         // Make sure video element is visible and ready
         video.style.display = 'block';
         video.style.background = '#000';
         
         // Try to manually set up video stream as fallback
         try {
           const stream = await getUserMediaPolyfill({
             video: {
               facingMode: 'environment',
               width: { ideal: 1280, min: 640 },
               height: { ideal: 720, min: 480 }
             }
           });
           video.srcObject = stream;
           currentStream = stream;
           console.log('Manual video stream setup successful');
         } catch (e) {
           console.log('Manual stream setup failed, relying on QuaggaJS:', e);
         }
         
         // Configure QuaggaJS with improved accuracy settings
         Quagga.init({
           inputStream: {
             name: "Live",
             type: "LiveStream",
             target: video,
             constraints: {
               width: { min: 640, ideal: 1280, max: 1920 },
               height: { min: 480, ideal: 720, max: 1080 },
               facingMode: "environment", // Use back camera on mobile
               aspectRatio: { min: 1, max: 2 }
             },
             area: { // Scan the full video area for better detection
               top: "0%",
               right: "0%",
               left: "0%",
               bottom: "0%"
             }
           },
           decoder: {
             readers: [
               "code_128_reader",
               "ean_reader",
               "ean_8_reader",
               "code_39_reader",
               "code_39_vin_reader",
               "codabar_reader",
               "upc_reader",
               "upc_e_reader",
               "i2of5_reader"
             ],
             multiple: false, // Only return one result at a time
             debug: {
               showCanvas: debugMode, // Show the canvas for debugging
               showPatches: debugMode, // Show detected patches
               showFoundPatches: debugMode, // Show found patches
               showSkeleton: false,
               showLabels: debugMode, // Show labels for debugging
               showPatchLabels: false,
               showRemainingPatchLabels: false,
               boxFromPatches: {
                 showTransformed: false,
                 showTransformedBox: false,
                 showBB: debugMode // Show bounding boxes
               }
             }
           },
           locate: true,
           frequency: 5, // Scan every 5 frames for better accuracy
           numOfWorkers: 4 // Use more workers for better performance
         }, function(err) {
           if (err) {
             console.error('QuaggaJS initialization failed:', err);
             showToast('Scanner initialization failed: ' + err.message, 'error');
             return;
           }
           
           console.log('QuaggaJS initialized successfully');
           showToast('Scanner started successfully!', 'success');
           isScanning = true;
           
           // Start scanning
           Quagga.start();
           
           // Add visual feedback
           video.classList.add('testing');
           video.classList.remove('error');
           
           // Log video element status
           console.log('Video element status:', {
             display: video.style.display,
             srcObject: !!video.srcObject,
             videoWidth: video.videoWidth,
             videoHeight: video.videoHeight,
             readyState: video.readyState
           });
         });
         
         // Handle successful scans with improved validation
         Quagga.onDetected(function(result) {
           const code = result.codeResult.code;
           const confidence = result.codeResult.confidence;
           const format = result.codeResult.format;
           
           if (debugMode) {
             console.log('=== BARCODE DETECTION DEBUG ===');
             console.log('Raw result:', result);
             console.log('Code:', code);
             console.log('Confidence:', confidence);
             console.log('Format:', format);
             console.log('==============================');
           } else {
             console.log('Barcode detected:', {
               code: code,
               confidence: confidence,
               format: format
             });
           }
           
           // Validate the detected code
           const validation = validateBarcode(code);
           if (!validation.valid) {
             console.log('Invalid barcode detected:', code, 'reason:', validation.reason);
             return;
           }
           
           // Check confidence level (higher is better)
           if (confidence < 0.3) {
             console.log('Low confidence barcode detected:', code, 'confidence:', confidence);
             showToast(`Low confidence: ${code} (${Math.round(confidence * 100)}%)`, 'warning');
             return;
           }
           
           // Use the cleaned code if available
           const finalCode = validation.cleanCode || code;
           
           const now = Date.now();
           // Deduplicate rapid repeats
           if (finalCode && (finalCode !== lastText || now - lastAt > 1500)) {
             lastText = finalCode;
             lastAt = now;
             
             console.log('Processing barcode:', finalCode, 'confidence:', confidence, 'format:', format, 'validation:', validation);
             postScan(finalCode);
             showToast(`Barcode detected: ${finalCode} (${Math.round(confidence * 100)}% confidence)`, 'success');
             
             // Add visual feedback
             video.style.border = '3px solid #4CAF50';
             setTimeout(() => {
               video.style.border = '';
             }, 2000);
           }
         });
         
         showToast('Scanner started successfully!', 'success');
         console.log('Scanning started successfully');
         
       } catch (e) {
         console.error('Scanning start failed:', e);
         showToast('Failed to start scanning: ' + e.message, 'error');
       }
     }

         async function stopScanning() {
       if (isScanning) {
         try {
           // Stop QuaggaJS
           Quagga.stop();
           isScanning = false;
           
           // Stop the video stream
           if (currentStream) {
             currentStream.getTracks().forEach(track => track.stop());
             currentStream = null;
           }
           
           // Clear video element
           video.srcObject = null;
           video.style.display = 'none';
           
           // Remove visual feedback
           video.classList.remove('testing', 'error');
           
           showToast('Scanner stopped');
           console.log('Scanner stopped');
         } catch (e) {
           console.error('Error stopping scanner:', e);
         }
       }
     }
    
    

         startBtn.addEventListener('click', startScanning);
     stopBtn.addEventListener('click', stopScanning);
     
     // Debug mode toggle
     document.getElementById('debugBtn').addEventListener('click', () => {
       debugMode = !debugMode;
       const debugBtn = document.getElementById('debugBtn');
       debugBtn.textContent = debugMode ? 'üîß Debug Mode: ON' : 'üîß Debug Mode: OFF';
       debugBtn.className = debugMode ? 'success' : 'secondary';
       
       if (debugMode) {
         showToast('Debug mode enabled - check console for detailed logs', 'info');
       } else {
         showToast('Debug mode disabled', 'info');
       }
     });
    
    manualBtn.addEventListener('click', () => {
      const val = (manualInput.value || '').trim();
      if (!val) return showToast('Enter a barcode', 'error');
      postScan(val);
      manualInput.value = '';
    });

         newItemForm.addEventListener('submit', async (e) => {
       e.preventDefault();
       
               const itemNameInput = document.getElementById('itemName');
        const itemName = itemNameInput.value.trim();
        const itemGame = document.getElementById('itemGame').value || null;
        const itemSet = document.getElementById('itemSet').value || null;
        const itemBrand = document.getElementById('itemBrand').value || null;
        const itemQuantity = parseInt(document.getElementById('itemQuantity').value) || 1;
        const itemPrice = parseFloat(document.getElementById('itemPrice').value) || null;
        const itemLocation = document.getElementById('itemLocation').value || null;
        const itemDescription = document.getElementById('itemDescription').value || null;
        const itemNotes = document.getElementById('itemNotes').value || null;

       if (!itemName) {
         showToast('Item name cannot be empty.', 'error');
         return;
       }

       if (!pendingBarcode) {
         showToast('No barcode found. Please scan again.', 'error');
         return;
       }

               const formData = {
          barcode: pendingBarcode,
          name: itemName,
          game: itemGame,
          set_name: itemSet,
          brand: itemBrand,
          quantity: itemQuantity,
          location: itemLocation,
          notes: itemNotes,
          price: itemPrice,
          description: itemDescription,
        };
       
       await createNewItem(formData);
     });

     editItemForm.addEventListener('submit', async (e) => {
       e.preventDefault();
       
               const itemNameInput = document.getElementById('editItemName');
        const itemName = itemNameInput.value.trim();
        const itemGame = document.getElementById('editItemGame').value || null;
        const itemSet = document.getElementById('editItemSet').value || null;
        const itemBrand = document.getElementById('editItemBrand').value || null;
        const itemQuantity = parseInt(document.getElementById('editItemQuantity').value) || 1;
        const itemPrice = parseFloat(document.getElementById('editItemPrice').value) || null;
        const itemLocation = document.getElementById('editItemLocation').value || null;
        const itemDescription = document.getElementById('editItemDescription').value || null;
        const itemNotes = document.getElementById('editItemNotes').value || null;

       if (!itemName) {
         showToast('Item name cannot be empty.', 'error');
         return;
       }

               const formData = {
          name: itemName,
          game: itemGame,
          set_name: itemSet,
          brand: itemBrand,
          quantity: itemQuantity,
          location: itemLocation,
          notes: itemNotes,
          price: itemPrice,
          description: itemDescription,
        };
       
       await updateItem(formData);
     });

         // Close modal when clicking outside
     newItemModal.addEventListener('click', (e) => {
       if (e.target === newItemModal) {
         closeNewItemModal();
       }
     });

     editItemModal.addEventListener('click', (e) => {
       if (e.target === editItemModal) {
         closeEditItemModal();
       }
     });

         // Inventory management buttons
     document.getElementById('viewInventoryBtn').addEventListener('click', viewInventory);
     document.getElementById('searchInventoryBtn').addEventListener('click', searchInventory);
     document.getElementById('exportInventoryBtn').addEventListener('click', exportInventory);
     document.getElementById('closeInventoryBtn').addEventListener('click', closeInventoryInline);
     
     // Selection buttons
     document.getElementById('selectAllBtn').addEventListener('click', toggleSelectAll);
     document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedItems);
     
     // Refresh button
     document.getElementById('refreshBtn').addEventListener('click', () => {
       showToast('Refreshing page...', 'info');
       setTimeout(() => {
         window.location.reload();
       }, 500);
     });

    // Inventory management functions
    async function viewInventory() {
      try {
        console.log('View inventory button clicked');
        showToast('Loading inventory...', 'info');
        
        console.log('Fetching from /api/items...');
        const response = await fetch('/api/items');
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          console.error('Response not ok:', response.status, response.statusText);
          throw new Error(`Failed to load inventory: ${response.status} ${response.statusText}`);
        }
        
        const items = await response.json();
        console.log('Items loaded:', items.length, 'items');
        displayInventoryInline(items, 'My Card Inventory');
      } catch (error) {
        console.error('Error loading inventory:', error);
        showToast(`Failed to load inventory: ${error.message}`, 'error');
      }
    }

    async function searchInventory() {
      const searchTerm = prompt('Enter search term (card name, game, set, etc.):');
      if (!searchTerm) return;
      
      try {
        console.log('Search inventory button clicked, term:', searchTerm);
        showToast('Searching...', 'info');
        
        const url = `/api/items?search=${encodeURIComponent(searchTerm)}`;
        console.log('Fetching from:', url);
        const response = await fetch(url);
        console.log('Search response status:', response.status);
        
        if (!response.ok) {
          console.error('Search response not ok:', response.status, response.statusText);
          throw new Error(`Failed to search inventory: ${response.status} ${response.statusText}`);
        }
        
        const items = await response.json();
        console.log('Search results:', items.length, 'items');
        displayInventoryInline(items, `Search Results: "${searchTerm}"`);
      } catch (error) {
        console.error('Error searching inventory:', error);
        showToast(`Failed to search inventory: ${error.message}`, 'error');
      }
    }

    async function exportInventory() {
      try {
        showToast('Exporting data...', 'info');
        const response = await fetch('/api/items');
        if (!response.ok) throw new Error('Failed to export inventory');
        
        const items = await response.json();
        
        // Create CSV content
        const csvContent = createCSV(items);
        
        // Download file
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `card-inventory-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('Inventory exported successfully!', 'success');
      } catch (error) {
        console.error('Error exporting inventory:', error);
        showToast('Failed to export inventory', 'error');
      }
    }

         function createCSV(items) {
       const headers = ['ID', 'Name', 'Game', 'Set', 'Brand', 'Quantity', 'Location', 'Price', 'Description', 'Notes', 'Added'];
       const rows = items.map(item => [
         item.id,
         item.name || '',
         item.game || '',
         item.set_name || '',
         item.brand || '',
         item.quantity || 0,
         item.location || '',
         item.price || '',
         item.description || '',
         item.notes || '',
         item.created_at ? item.created_at.split('T')[0] : ''
       ]);
      
      return [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
    }

                   function displayInventoryInline(items, title) {
        // Store items globally for selection functionality
        allItems = items;
        selectedItems.clear();
        
        // Get the inventory section elements
        const inventorySection = document.getElementById('inventorySection');
        const inventoryTitle = document.getElementById('inventoryTitle');
        const inventoryCount = document.getElementById('inventoryCount');
        const inventoryList = document.getElementById('inventoryList');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        
        // Update the title and count
        inventoryTitle.textContent = title;
        inventoryCount.textContent = `${items.length} items found`;
        
        // Reset selection controls
        selectAllBtn.textContent = '‚òê Select All';
        deleteSelectedBtn.style.display = 'none';
        document.getElementById('selectedCount').textContent = '0';
        
        // Clear the list and add items
        inventoryList.innerHTML = '';
        
        if (items.length === 0) {
          inventoryList.innerHTML = '<p>No items found in inventory.</p>';
        } else {
          items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'inventory-item';
            itemElement.dataset.itemId = item.id;
            itemElement.innerHTML = `
              <div class="item-header">
                <div class="item-selection">
                  <input type="checkbox" class="item-checkbox" id="checkbox-${item.id}" onchange="toggleItemSelection(${item.id})">
                  <strong>${item.name || 'Unknown Card'}</strong>
                </div>
                <div class="item-actions">
                  <span class="quantity">Qty: ${item.quantity}</span>
                  <button class="edit-btn" onclick="editItem(${item.id})" title="Edit this card">‚úèÔ∏è Edit</button>
                </div>
              </div>
                             <div class="item-details">
                 <span class="game">${item.game || 'Unknown Game'}</span>
                 ${item.set_name ? `<span class="set">${item.set_name}</span>` : ''}
                 ${item.brand ? `<span class="brand">${item.brand}</span>` : ''}
                 ${item.price ? `<span class="price">$${parseFloat(item.price).toFixed(2)}</span>` : ''}
               </div>
              ${item.location ? `<div class="location">üìç ${item.location}</div>` : ''}
              ${item.description ? `<div class="description">${item.description}</div>` : ''}
            `;
            inventoryList.appendChild(itemElement);
          });
        }
        
        // Show the inventory section
        inventorySection.style.display = 'block';
        
        // Scroll to the inventory section
        inventorySection.scrollIntoView({ behavior: 'smooth' });
      }

         function closeInventoryInline() {
       const inventorySection = document.getElementById('inventorySection');
       inventorySection.style.display = 'none';
     }

           // Global function for edit button onclick
      function editItem(itemId) {
        showEditItemModal(itemId);
      }

      // Selection functions
      function toggleItemSelection(itemId) {
        const checkbox = document.getElementById(`checkbox-${itemId}`);
        const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
        
        if (checkbox.checked) {
          selectedItems.add(itemId);
          itemElement.classList.add('selected');
        } else {
          selectedItems.delete(itemId);
          itemElement.classList.remove('selected');
        }
        
        updateSelectionUI();
      }

      function toggleSelectAll() {
        const selectAllBtn = document.getElementById('selectAllBtn');
        const checkboxes = document.querySelectorAll('.item-checkbox');
        const itemElements = document.querySelectorAll('.inventory-item');
        
        if (selectedItems.size === allItems.length) {
          // Deselect all
          selectedItems.clear();
          checkboxes.forEach(checkbox => checkbox.checked = false);
          itemElements.forEach(item => item.classList.remove('selected'));
          selectAllBtn.textContent = '‚òê Select All';
        } else {
          // Select all
          selectedItems.clear();
          allItems.forEach(item => selectedItems.add(item.id));
          checkboxes.forEach(checkbox => checkbox.checked = true);
          itemElements.forEach(item => item.classList.add('selected'));
          selectAllBtn.textContent = '‚òë Deselect All';
        }
        
        updateSelectionUI();
      }

      function updateSelectionUI() {
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const selectedCount = document.getElementById('selectedCount');
        
        selectedCount.textContent = selectedItems.size;
        
        if (selectedItems.size > 0) {
          deleteSelectedBtn.style.display = 'inline-block';
        } else {
          deleteSelectedBtn.style.display = 'none';
        }
        
        // Update select all button text
        if (selectedItems.size === allItems.length && allItems.length > 0) {
          selectAllBtn.textContent = '‚òë Deselect All';
        } else {
          selectAllBtn.textContent = '‚òê Select All';
        }
      }

      async function deleteSelectedItems() {
        if (selectedItems.size === 0) {
          showToast('No items selected', 'warning');
          return;
        }

        const itemNames = allItems
          .filter(item => selectedItems.has(item.id))
          .map(item => item.name || 'Unknown Card');

        const confirmed = confirm(
          `Are you sure you want to delete ${selectedItems.size} item(s)?\n\n` +
          `Items to delete:\n${itemNames.slice(0, 5).join('\n')}${itemNames.length > 5 ? '\n... and ' + (itemNames.length - 5) + ' more' : ''}\n\n` +
          `This action cannot be undone.`
        );

        if (!confirmed) {
          return;
        }

        try {
          showToast(`Deleting ${selectedItems.size} items...`, 'warning');
          
          // Delete items one by one
          const deletePromises = Array.from(selectedItems).map(itemId =>
            fetch(`/api/items/${itemId}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' }
            })
          );

          const results = await Promise.allSettled(deletePromises);
          
          // Check for errors
          const errors = results.filter(result => result.status === 'rejected' || (result.value && !result.value.ok));
          
          if (errors.length > 0) {
            console.error('Some deletions failed:', errors);
            showToast(`Deleted ${selectedItems.size - errors.length} items, ${errors.length} failed`, 'warning');
          } else {
            showToast(`Successfully deleted ${selectedItems.size} items`, 'success');
          }

          // Clear selection and refresh inventory
          selectedItems.clear();
          await viewInventory();
          
        } catch (error) {
          console.error('Error deleting items:', error);
          showToast('Failed to delete items', 'error');
        }
      }
  </script>
</body>
</html>